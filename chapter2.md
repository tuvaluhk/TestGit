# 二、coherence基本知识

## 2.1、基本系统模型

​	教材使用的系统是共享主存的多处理内核系统，所有内核可以所有内存物理地址进行读写。基本的系统模型包含一个**多核处理器芯片**和**片外主存**，多处理核芯片由多个单线程核组成，每个核有独立的数据缓存（L1cache），片上还有一个所有核共享的最后一级缓存（LLC）。

​	后面的“cache”指的是核的独立数据缓存，可通过物理地址访问，采用**写回机制**，片上还有一个供核与LLC通信的**互联网络**。LLC是作为内存的缓存，不引入缓存一致性问题，主要作用是降低内存访问的延迟、增加带宽，LLC也作为片上内存控制器。

<img src="C:\Users\lshlab\AppData\Roaming\Typora\typora-user-images\image-20210123171429423.png" style="zoom:80%;" />

## 2.2  问题：incoherence是怎么发生的

​	系统的参与者有**内核**、**DMA（direct memory access）引擎**和**外接设备**等可以读写缓存和内存的设备，它们带来了缓存不一致的基本问题：**存在多个参与者可以访问缓存和内存**。

​	比如下图所示，在1时刻C1把内存地址A的值42读进自己的缓存，在2时刻C2把内存地址A的值42读进自己的缓存，但在3时刻C1把缓存中存放的A的值42增加到43，使C2缓存中存放的A值42**不新鲜**了（**incoherence**），这种情况下，需要缓存一致性协议的实现纠正这种**C1的A值为43而C2的A值为42**的内核行为

<img src="C:\Users\lshlab\AppData\Roaming\Typora\typora-user-images\image-20210123173251142.png" alt="image-20210123173251142" style="zoom:80%;" />

## 2.3 coherence定义

​	***SWMR***（*single-writer-multiple-reader*）不变式：对每个内存位置，在逻辑时间的每个时期，要么是单个有读-写权限的核访问内存位置，要么是多个有读权限的核访问内存位置。

<img src="C:\Users\lshlab\AppData\Roaming\Typora\typora-user-images\image-20210123174242255.png" alt="image-20210123174242255" style="zoom:80%;" />

​	除了***SWMR***不变式，coherence还要求给定内存位置的值正确传播，比如即便维持***SWMR***不变式，如上图，如果C2与C5读到了不同的值，这也不是coherent的，还有C1读不到C3写的值、C1、2、3读不到C1写的值这样的不一致错误。

​	加入***data value***不变式关于值是怎么从一个阶段传向下个阶段，即**值传递**。

### 2.3.1 保持Coherence Invariants

​	coherence协议的很大一部分“无效协议”是显示定义，以保持这些不变式，比如某核**读取**一个内存位置保存的数据，它给其它核发送消息以**保持**内存位置中的当前值与保证在其他缓存中保存的copies没有一个处在读-写状态，发送的消息**结束所有读-写阶段，开启只读阶段**。在**写内存**，内核给其他核发消息去**获取**当前值和确保没有其它核的缓存数据处在读或读写状态，发送的消息**结束所有读-写或读阶段，开启一个读-写阶段**。

### 2.3.2 Coherence的粒度

​	处理器核可以以不同粒度实现读写，通常从1~64字节。理论上，coherence可以在最小的读/写粒度上实现，但实际上coherence会维持在**等于缓存块大小**的粒度。

## Sidebar：像Consistency一样定义Coherence（Coherence的其他定义）

​	Coherence的定义可以像Consistency一样用读/写定义，就像*consistency*为读/写规定了架构上可见的顺序一样。

根据顺序consistency（SC）定义：SC规定系统必须按代表每个线程在程序中顺序的总顺序执行所有线程对**所有内存地址**的读/写。

①得到类似的coherence定义：缓存一致性系统必须按代表每个线程在程序中的顺序的总顺序执行对**每个内存地址**的读/写。

对比两个定义，可以看出coherence是基于**每个内存位置**规定的，然而consistency规定的是**所有内存位置**的行为。

②另一种coherence定义是：（1）所有内核最终都能知道每个写的内容 （2）对同个内存位置的写操作是排序的（所有核都知道写入的顺序）

③第三种定义：（1）一个核对内存位置A的读得到的值是该核上一个对A的写操作的值 （2）一个对A的读得到的是另一个核对A的写操作S留下的值，读与S“在时间上是充分分开的”且没有其它存储在它们之间发生 （3）对相同内存地址的写操作是序列化的（上定义（2））

### 2.3.3 Coherence的范围

* *Coherence*属于存储结构，即从共享地址空间中取出数据块
* Coherence不属于体系结构的一部分，一个系统可以不包含coherence但只要遵守规定的内存一致性模型的话。